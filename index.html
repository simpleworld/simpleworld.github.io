<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Browser FPS - Pro-Dev Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #crosshair {
            position: absolute; top: 50%; left: 50%;
            width: 20px; height: 20px;
            border: 2px solid rgba(0, 255, 0, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; z-index: 10;
        }
        #crosshair::before, #crosshair::after {
            content: ''; position: absolute; background: #0f0;
        }
        #crosshair::before { top: 50%; left: -5px; width: 30px; height: 2px; margin-top: -1px; }
        #crosshair::after { left: 50%; top: -5px; width: 2px; height: 30px; margin-left: -1px; }

        #ui {
            position: absolute; bottom: 20px; left: 20px;
            color: white; text-shadow: 2px 2px #000; font-size: 24px; pointer-events: none;
        }
        #weapon-info { position: absolute; bottom: 20px; right: 20px; color: #fb0; font-size: 32px; text-align: right; }
        #instructions {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; background: rgba(0,0,0,0.8); padding: 20px; text-align: center;
            border: 2px solid #fb0; cursor: pointer; z-index: 20;
        }
    </style>
</head>
<body>

    <div id="crosshair"></div>
    <div id="ui">HP: 100</div>
    <div id="weapon-info">ЗБРОЯ: AWP<br><small>Набої: ∞</small></div>
    <div id="instructions">
        <h1>КЛІКНІТЬ, ЩОБ ПОЧАТИ ГРУ</h1>
        <p>W, A, S, D — Рух | 1, 2, 3 — Зміна зброї</p>
        <p>ЛКМ — Стрільба / Удар</p>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- ГЛОБАЛЬНІ ЗМІННІ ---
        let scene, camera, renderer, raycaster;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        let prevTime = performance.now();
        
        const objects = []; // Для колізій
        let currentWeapon = 'AWP';
        let isReloading = false;
        let weaponMesh;
        const weapons = {
            '1': { name: 'AWP', damage: 100, speed: 1.5, color: 0x556b2f, recoil: 0.1, isMelee: false },
            '2': { name: 'Glock', damage: 20, speed: 0.2, color: 0x333333, recoil: 0.02, isMelee: false },
            '3': { name: 'Ніж', damage: 50, speed: 0.5, color: 0xaaaaaa, recoil: 0, isMelee: true }
        };

        init();
        animate();

        function init() {
            // Сцена
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb); // Небо
            scene.fog = new THREE.Fog(0x87ceeb, 0, 100);

            // Камера
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 1.6; // Ріст гравця

            // Світло
            const light = new THREE.HemisphereLight(0xeeeeff, 0x444422, 1.5);
            scene.add(light);
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(10, 20, 10);
            scene.add(sun);

            // Рендерер
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Raycaster для стрільби та колізій
            raycaster = new THREE.Raycaster();

            // Керування мишкою
            const instructions = document.getElementById('instructions');
            instructions.addEventListener('click', () => {
                document.body.requestPointerLock();
            });

            document.addEventListener('pointerlockchange', () => {
                instructions.style.display = document.pointerLockElement === document.body ? 'none' : 'block';
            });

            document.addEventListener('mousemove', (e) => {
                if (document.pointerLockElement === document.body) {
                    camera.rotation.y -= e.movementX * 0.002;
                    const newX = camera.rotation.x - e.movementY * 0.002;
                    camera.rotation.x = Math.max(-Math.PI/2.1, Math.min(Math.PI/2.1, newX));
                }
            });

            // Клавіатура
            const onKeyDown = (e) => {
                switch (e.code) {
                    case 'KeyW': moveForward = true; break;
                    case 'KeyS': moveBackward = true; break;
                    case 'KeyA': moveLeft = true; break;
                    case 'KeyD': moveRight = true; break;
                    case 'Digit1': switchWeapon('1'); break;
                    case 'Digit2': switchWeapon('2'); break;
                    case 'Digit3': switchWeapon('3'); break;
                }
            };
            const onKeyUp = (e) => {
                switch (e.code) {
                    case 'KeyW': moveForward = false; break;
                    case 'KeyS': moveBackward = false; break;
                    case 'KeyA': moveLeft = false; break;
                    case 'KeyD': moveRight = false; break;
                }
            };
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousedown', shoot);

            // --- КАРТА ---
            // Підлога
            const floorGeo = new THREE.PlaneGeometry(200, 200);
            const floorMat = new THREE.MeshPhongMaterial({ color: 0x444444 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Створення будівель (коробок)
            createBox(10, 5, -20, 8, 10, 8, 0x888888);
            createBox(-15, 3, -10, 5, 6, 5, 0x666666);
            createBox(0, 1, -30, 20, 2, 5, 0x777777);
            createBox(20, 10, 10, 10, 20, 10, 0x555555);

            // Візуалізація зброї в руці
            createWeaponMesh();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function createBox(x, y, z, w, h, d, color) {
            const geo = new THREE.BoxGeometry(w, h, d);
            const mat = new THREE.MeshPhongMaterial({ color });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(x, y, z);
            scene.add(mesh);
            objects.push(mesh);
        }

        function createWeaponMesh() {
            if (weaponMesh) camera.remove(weaponMesh);
            
            const weaponData = weapons[Object.keys(weapons).find(k => weapons[k].name === currentWeapon)];
            
            let geo;
            if (currentWeapon === 'AWP') geo = new THREE.BoxGeometry(0.1, 0.1, 0.8);
            else if (currentWeapon === 'Glock') geo = new THREE.BoxGeometry(0.08, 0.15, 0.3);
            else geo = new THREE.BoxGeometry(0.05, 0.05, 0.4); // Ніж

            const mat = new THREE.MeshPhongMaterial({ color: weaponData.color });
            weaponMesh = new THREE.Mesh(geo, mat);
            weaponMesh.position.set(0.3, -0.3, -0.5);
            camera.add(weaponMesh);
            scene.add(camera);
        }

        function switchWeapon(key) {
            if (weapons[key]) {
                currentWeapon = weapons[key].name;
                document.getElementById('weapon-info').innerHTML = `ЗБРОЯ: ${currentWeapon}<br><small>Набої: ∞</small>`;
                createWeaponMesh();
            }
        }

        function shoot() {
            if (isReloading || document.pointerLockElement !== document.body) return;

            const weaponData = weapons[Object.keys(weapons).find(k => weapons[k].name === currentWeapon)];
            isReloading = true;

            // Анімація віддачі
            weaponMesh.position.z += 0.1;
            setTimeout(() => { weaponMesh.position.z -= 0.1; isReloading = false; }, weaponData.speed * 1000);

            // Промінь пострілу
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            const intersects = raycaster.intersectObjects(objects);

            if (!weaponData.isMelee) {
                // Трасер для AWP/Glock
                const lineMat = new THREE.LineBasicMaterial({ color: 0xffff00 });
                const points = [
                    new THREE.Vector3(0.3, -0.3, -0.5).applyMatrix4(camera.matrixWorld),
                    intersects.length > 0 ? intersects[0].point : raycaster.ray.at(50, new THREE.Vector3())
                ];
                const lineGeo = new THREE.BufferGeometry().setFromPoints(points);
                const line = new THREE.Line(lineGeo, lineMat);
                scene.add(line);
                setTimeout(() => scene.remove(line), 50);

                // Ефект попадання
                if (intersects.length > 0) {
                    const dotGeo = new THREE.SphereGeometry(0.05);
                    const dotMat = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                    const dot = new THREE.Mesh(dotGeo, dotMat);
                    dot.position.copy(intersects[0].point);
                    scene.add(dot);
                    setTimeout(() => scene.remove(dot), 200);
                }
            } else {
                // Логіка ножа (короткий радіус)
                if (intersects.length > 0 && intersects[0].distance < 2) {
                    intersects[0].object.material.color.setHex(0xff0000);
                    setTimeout(() => intersects[0].object.material.color.setHex(0x888888), 100);
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            // Фізика руху та колізії (спрощено)
            velocity.x -= velocity.x * 10.0 * delta;
            velocity.z -= velocity.z * 10.0 * delta;

            direction.z = Number(moveForward) - Number(moveBackward);
            direction.x = Number(moveRight) - Number(moveLeft);
            direction.normalize();

            if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
            if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;

            const nextPos = camera.position.clone();
            nextPos.translateX(velocity.x * delta);
            nextPos.translateZ(velocity.z * delta);

            // Проста перевірка меж карти та стін
            let canMove = true;
            if (Math.abs(nextPos.x) > 95 || Math.abs(nextPos.z) > 95) canMove = false;
            
            // Перевірка колізій з об'єктами
            const playerRay = new THREE.Raycaster(camera.position, direction.applyQuaternion(camera.quaternion), 0, 1.5);
            const hits = playerRay.intersectObjects(objects);
            if (hits.length > 0) canMove = false;

            if (canMove) {
                camera.translateX(velocity.x * delta);
                camera.translateZ(velocity.z * delta);
            } else {
                velocity.set(0,0,0);
            }

            camera.position.y = 1.6; // Тримаємо висоту (гравітація/земля)

            prevTime = time;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
