<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger - Telegram Style</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f4f4f5;
            --bg-tertiary: #e5e5ea;
            --text-primary: #000000;
            --text-secondary: #6e6e73;
            --accent: #0088cc;
            --accent-hover: #006699;
            --message-out: #effdde;
            --message-in: #ffffff;
            --border: #d1d1d6;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #212121;
            --bg-secondary: #181818;
            --bg-tertiary: #2c2c2c;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --accent: #5eb3f6;
            --accent-hover: #4a9dd9;
            --message-out: #2b5278;
            --message-in: #2c2c2c;
            --border: #3a3a3a;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* ========== AUTH SCREEN ========== */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
        }

        .auth-box {
            background: var(--bg-primary);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px var(--shadow);
            width: 400px;
            max-width: 90%;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: var(--accent);
            font-size: 32px;
            margin-bottom: 8px;
        }

        .auth-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--accent);
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
        }

        .error-message {
            background: #ff3b30;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* ========== MAIN APP ========== */
        .app-container {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .app-container.active {
            display: flex;
        }

        /* Header */
        .app-header {
            background: var(--accent);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .app-header h1 {
            font-size: 20px;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            text-align: right;
        }

        .user-nickname {
            font-weight: 600;
            font-size: 15px;
        }

        .user-status {
            font-size: 12px;
            opacity: 0.8;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-logout {
            background: rgba(255, 59, 48, 0.9);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255, 59, 48, 1);
        }

        /* Main Content */
        .app-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .search-container {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-item:hover {
            background: var(--bg-secondary);
        }

        .chat-item.active {
            background: var(--bg-tertiary);
        }

        .chat-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .chat-item-name {
            font-weight: 600;
            font-size: 15px;
        }

        .chat-item-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chat-item-preview {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .empty-chats {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
        }

        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
        }

        .empty-chat-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .chat-header {
            background: var(--bg-primary);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: none;
        }

        .chat-header.active {
            display: block;
        }

        .chat-header-name {
            font-size: 16px;
            font-weight: 600;
        }

        .chat-header-status {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }

        .messages-container.active {
            display: block;
        }

        .message {
            display: flex;
            margin-bottom: 12px;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.out {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 60%;
            padding: 10px 14px;
            border-radius: 12px;
            position: relative;
        }

        .message.in .message-bubble {
            background: var(--message-in);
            border: 1px solid var(--border);
            border-bottom-left-radius: 2px;
        }

        .message.out .message-bubble {
            background: var(--message-out);
            border-bottom-right-radius: 2px;
        }

        .message-text {
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            text-align: right;
        }

        .message.in .message-time {
            text-align: left;
        }

        /* Input Area */
        .input-area {
            background: var(--bg-primary);
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: none;
        }

        .input-area.active {
            display: block;
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-container textarea {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .input-container textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-send {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-send:hover {
            background: var(--accent-hover);
        }

        .btn-send:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
            }

            .chat-area {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 10;
                display: none;
            }

            .chat-area.mobile-active {
                display: flex;
            }

            .message-bubble {
                max-width: 80%;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- ========== AUTH SCREEN ========== -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <!-- Login Form -->
            <div id="loginForm">
                <div class="auth-header">
                    <h1>Messenger</h1>
                    <p>–£–≤—ñ–π–¥—ñ—Ç—å —É —Å–≤—ñ–π –∞–∫–∞—É–Ω—Ç</p>
                </div>
                <div class="error-message" id="loginError"></div>
                <div class="form-group">
                    <label for="loginUsername">–õ–æ–≥—ñ–Ω</label>
                    <input type="text" id="loginUsername" placeholder="–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω">
                </div>
                <div class="form-group">
                    <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn btn-primary" onclick="login()">–£–≤—ñ–π—Ç–∏</button>
                <button class="btn btn-secondary" onclick="showRegister()">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç</button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <div class="auth-header">
                    <h1>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h1>
                    <p>–°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –∞–∫–∞—É–Ω—Ç</p>
                </div>
                <div class="error-message" id="registerError"></div>
                <div class="form-group">
                    <label for="registerNickname">–ù—ñ–∫–Ω–µ–π–º</label>
                    <input type="text" id="registerNickname" placeholder="–í–∞—à –Ω—ñ–∫–Ω–µ–π–º">
                </div>
                <div class="form-group">
                    <label for="registerUsername">–õ–æ–≥—ñ–Ω</label>
                    <input type="text" id="registerUsername" placeholder="–°—Ç–≤–æ—Ä—ñ—Ç—å –ª–æ–≥—ñ–Ω">
                </div>
                <div class="form-group">
                    <label for="registerPassword">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="registerPassword" placeholder="–°—Ç–≤–æ—Ä—ñ—Ç—å –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn btn-primary" onclick="register()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
                <button class="btn btn-secondary" onclick="showLogin()">–í–∂–µ —î –∞–∫–∞—É–Ω—Ç</button>
            </div>
        </div>
    </div>

    <!-- ========== MAIN APP ========== -->
    <div class="app-container" id="appContainer">
        <div class="app-header">
            <h1>Messenger</h1>
            <div class="header-user">
                <div class="user-info">
                    <div class="user-nickname" id="currentUserNickname"></div>
                    <div class="user-status">–≤ –º–µ—Ä–µ–∂—ñ</div>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()">üåì –¢–µ–º–∞</button>
                <button class="btn-logout" onclick="logout()">–í–∏–π—Ç–∏</button>
            </div>
        </div>

        <div class="app-main">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤..." onkeyup="searchUsers()">
                    </div>
                </div>
                <div class="chat-list" id="chatList">
                    <div class="empty-chats">
                        <p>–ü–æ—á–Ω—ñ—Ç—å —Ä–æ–∑–º–æ–≤—É!</p>
                        <p style="font-size: 13px; margin-top: 8px;">–ó–Ω–∞–π–¥—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ –Ω—ñ–∫–Ω–µ–π–º–æ–º</p>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area" id="chatArea">
                <div class="empty-chat">
                    <div class="empty-chat-icon">üí¨</div>
                    <h2>–í–∏–±–µ—Ä—ñ—Ç—å —á–∞—Ç</h2>
                    <p>–û–±–µ—Ä—ñ—Ç—å –¥—ñ–∞–ª–æ–≥ –∑–ª—ñ–≤–∞ –∞–±–æ –∑–Ω–∞–π–¥—ñ—Ç—å –Ω–æ–≤–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞</p>
                </div>

                <div class="chat-header" id="chatHeader">
                    <div class="chat-header-name" id="chatHeaderName"></div>
                    <div class="chat-header-status">–≤ –º–µ—Ä–µ–∂—ñ</div>
                </div>

                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be loaded here -->
                </div>

                <div class="input-area" id="inputArea">
                    <div class="input-container">
                        <textarea id="messageInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." rows="1" onkeydown="handleMessageKeyDown(event)"></textarea>
                        <button class="btn-send" onclick="sendMessage()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== GLOBALS ==========
        let currentUser = null;
        let activeChat = null;
        let lastMessageCount = 0;
        let autoRefreshInterval = null;

        // ========== UTILITY FUNCTIONS ==========
        
        // –ü—Ä–æ—Å—Ç–∞ —Ö–µ—à-—Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–∞—Ä–æ–ª—ñ–≤ (SHA-256 –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        // –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        function getUsers() {
            const users = localStorage.getItem('messenger_users');
            return users ? JSON.parse(users) : [];
        }

        // –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        function saveUsers(users) {
            localStorage.setItem('messenger_users', JSON.stringify(users));
        }

        // –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        function getMessages() {
            const messages = localStorage.getItem('messenger_messages');
            return messages ? JSON.parse(messages) : [];
        }

        // –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        function saveMessages(messages) {
            localStorage.setItem('messenger_messages', JSON.stringify(messages));
        }

        // –û—Ç—Ä–∏–º–∞—Ç–∏ ID —á–∞—Ç—É –º—ñ–∂ –¥–≤–æ–º–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏
        function getChatId(user1, user2) {
            return [user1, user2].sort().join('_');
        }

        // –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —á–∞—Å—É
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            if (date.toDateString() === now.toDateString()) {
                return `${hours}:${minutes}`;
            }
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            return `${day}.${month} ${hours}:${minutes}`;
        }

        // ========== AUTH FUNCTIONS ==========
        
        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 3000);
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function register() {
            const nickname = document.getElementById('registerNickname').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!nickname || !username || !password) {
                showError('registerError', '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è!');
                return;
            }

            if (nickname.length < 2 || username.length < 3) {
                showError('registerError', '–ù—ñ–∫–Ω–µ–π–º —Ç–∞ –ª–æ–≥—ñ–Ω –º–∞—é—Ç—å –±—É—Ç–∏ –¥–æ–≤—à—ñ!');
                return;
            }

            if (password.length < 4) {
                showError('registerError', '–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 4 —Å–∏–º–≤–æ–ª–∏!');
                return;
            }

            const users = getUsers();
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —ñ—Å–Ω—É—é—á–∏–π –ª–æ–≥—ñ–Ω
            if (users.find(u => u.username === username)) {
                showError('registerError', '–¢–∞–∫–∏–π –ª–æ–≥—ñ–Ω –≤–∂–µ —ñ—Å–Ω—É—î!');
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —ñ—Å–Ω—É—é—á–∏–π –Ω—ñ–∫–Ω–µ–π–º
            if (users.find(u => u.nickname === nickname)) {
                showError('registerError', '–¢–∞–∫–∏–π –Ω—ñ–∫–Ω–µ–π–º –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π!');
                return;
            }

            // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            const newUser = {
                id: Date.now().toString(),
                nickname: nickname,
                username: username,
                password: simpleHash(password),
                createdAt: Date.now()
            };

            users.push(newUser);
            saveUsers(users);

            // –û—á–∏—â–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏
            document.getElementById('registerNickname').value = '';
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerPassword').value = '';

            showLogin();
            showError('loginError', '‚úì –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –£–≤—ñ–π–¥—ñ—Ç—å —É —Å–∏—Å—Ç–µ–º—É.');
        }

        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showError('loginError', '–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω —Ç–∞ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            const users = getUsers();
            const user = users.find(u => u.username === username && u.password === simpleHash(password));

            if (!user) {
                showError('loginError', '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            // –£—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥
            currentUser = user;
            sessionStorage.setItem('currentUser', JSON.stringify(user));
            
            // –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –¥–æ–¥–∞—Ç–∫—É
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            
            initApp();
        }

        function logout() {
            // –ó—É–ø–∏–Ω—è—î–º–æ –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }

            currentUser = null;
            activeChat = null;
            sessionStorage.removeItem('currentUser');
            
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('active');
            
            // –û—á–∏—â–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏ –≤—Ö–æ–¥—É
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            
            showLogin();
        }

        // ========== APP FUNCTIONS ==========
        
        function initApp() {
            document.getElementById('currentUserNickname').textContent = currentUser.nickname;
            loadChats();
            startAutoRefresh();
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        function startAutoRefresh() {
            // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª —è–∫—â–æ —î
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 2 —Å–µ–∫—É–Ω–¥–∏
            autoRefreshInterval = setInterval(() => {
                checkForNewMessages();
            }, 2000);
        }

        function checkForNewMessages() {
            const messages = getMessages();
            const currentMessageCount = messages.length;

            // –Ø–∫—â–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑–º—ñ–Ω–∏–ª–∞—Å—å
            if (currentMessageCount !== lastMessageCount) {
                lastMessageCount = currentMessageCount;

                // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤
                const searchQuery = document.getElementById('searchInput').value.trim();
                if (!searchQuery) {
                    loadChats();
                }

                // –Ø–∫—â–æ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π –∞–∫—Ç–∏–≤–Ω–∏–π —á–∞—Ç - –æ–Ω–æ–≤–ª—é—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                if (activeChat) {
                    const chatId = getChatId(currentUser.username, activeChat.username);
                    const chatMessages = messages.filter(m => m.chatId === chatId);
                    const messagesContainer = document.getElementById('messagesContainer');
                    const currentScrollHeight = messagesContainer.scrollHeight;
                    const currentScrollTop = messagesContainer.scrollTop;
                    const isScrolledToBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop <= messagesContainer.clientHeight + 100;

                    loadMessages();

                    // –ü—Ä–æ–∫—Ä—É—á—É—î–º–æ –≤–Ω–∏–∑ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±—É–≤ –≤–Ω–∏–∑—É
                    if (isScrolledToBottom) {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }
            }
        }

        function loadChats() {
            const chatListEl = document.getElementById('chatList');
            const messages = getMessages();
            const users = getUsers().filter(u => u.id !== currentUser.id);

            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ç—ñ–ª—å–∫–∏ —Ç–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, –∑ —è–∫–∏–º–∏ —î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            const chatsWithMessages = [];
            
            users.forEach(user => {
                const chatId = getChatId(currentUser.username, user.username);
                const chatMessages = messages.filter(m => m.chatId === chatId);
                
                if (chatMessages.length > 0) {
                    const lastMessage = chatMessages[chatMessages.length - 1];
                    chatsWithMessages.push({
                        user: user,
                        lastMessage: lastMessage,
                        timestamp: lastMessage.timestamp
                    });
                }
            });

            if (chatsWithMessages.length === 0) {
                chatListEl.innerHTML = `
                    <div class="empty-chats">
                        <p>–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö —á–∞—Ç—ñ–≤</p>
                        <p style="font-size: 13px; margin-top: 8px;">–ó–Ω–∞–π–¥—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ –Ω—ñ–∫–Ω–µ–π–º–æ–º</p>
                    </div>
                `;
                return;
            }

            // –°–æ—Ä—Ç—É—î–º–æ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º
            chatsWithMessages.sort((a, b) => b.timestamp - a.timestamp);

            chatListEl.innerHTML = chatsWithMessages.map(chat => `
                <div class="chat-item ${activeChat && activeChat.id === chat.user.id ? 'active' : ''}" 
                     onclick="openChat('${chat.user.id}')">
                    <div class="chat-item-header">
                        <div class="chat-item-name">${chat.user.nickname}</div>
                        <div class="chat-item-time">${formatTime(chat.lastMessage.timestamp)}</div>
                    </div>
                    <div class="chat-item-preview">${escapeHtml(chat.lastMessage.text)}</div>
                </div>
            `).join('');
        }

        function searchUsers() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!query) {
                loadChats();
                return;
            }

            const users = getUsers().filter(u => 
                u.id !== currentUser.id && 
                u.nickname.toLowerCase().includes(query)
            );

            const chatListEl = document.getElementById('chatList');

            if (users.length === 0) {
                chatListEl.innerHTML = `
                    <div class="empty-chats">
                        <p>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>
                        <p style="font-size: 13px; margin-top: 8px;">–°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –∑–∞–ø–∏—Ç</p>
                    </div>
                `;
                return;
            }

            chatListEl.innerHTML = users.map(user => `
                <div class="chat-item ${activeChat && activeChat.id === user.id ? 'active' : ''}" 
                     onclick="openChat('${user.id}')">
                    <div class="chat-item-header">
                        <div class="chat-item-name">${user.nickname}</div>
                    </div>
                    <div class="chat-item-preview">@${user.username}</div>
                </div>
            `).join('');
        }

        function openChat(userId) {
            const users = getUsers();
            const user = users.find(u => u.id === userId);
            
            if (!user) return;

            activeChat = user;

            // –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç—É
            document.getElementById('chatHeaderName').textContent = user.nickname;
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏ —á–∞—Ç—É
            document.querySelector('.empty-chat').style.display = 'none';
            document.getElementById('chatHeader').classList.add('active');
            document.getElementById('messagesContainer').classList.add('active');
            document.getElementById('inputArea').classList.add('active');

            // –ú–æ–±—ñ–ª—å–Ω–∞ –≤–µ—Ä—Å—ñ—è
            document.getElementById('chatArea').classList.add('mobile-active');

            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            loadMessages();

            // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤
            loadChats();
        }

        function loadMessages() {
            if (!activeChat) return;

            const chatId = getChatId(currentUser.username, activeChat.username);
            const messages = getMessages().filter(m => m.chatId === chatId);
            const messagesContainer = document.getElementById('messagesContainer');

            messagesContainer.innerHTML = messages.map(msg => {
                const isOut = msg.from === currentUser.username;
                return `
                    <div class="message ${isOut ? 'out' : 'in'}">
                        <div class="message-bubble">
                            <div class="message-text">${escapeHtml(msg.text)}</div>
                            <div class="message-time">${formatTime(msg.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage() {
            if (!activeChat) return;

            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text) return;

            const chatId = getChatId(currentUser.username, activeChat.username);
            const messages = getMessages();

            const newMessage = {
                id: Date.now().toString(),
                chatId: chatId,
                from: currentUser.username,
                to: activeChat.username,
                text: text,
                timestamp: Date.now()
            };

            messages.push(newMessage);
            saveMessages(messages);

            // –û—á–∏—â—É—î–º–æ –ø–æ–ª–µ –≤–≤–æ–¥—É
            input.value = '';
            input.style.height = 'auto';

            // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            loadMessages();
            loadChats();
        }

        function handleMessageKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }

            // –ê–≤—Ç–æ-—Ä–æ–∑–º—ñ—Ä —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== THEME ==========
        
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ–º–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        }

        // ========== INITIALIZATION ==========
        
        window.onload = function() {
            loadTheme();

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
            lastMessageCount = getMessages().length;

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–æ—ó —Å–µ—Å—ñ—ó
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('appContainer').classList.add('active');
                initApp();
            }

            // Enter –Ω–∞ —Ñ–æ—Ä–º–∞—Ö
            document.getElementById('loginPassword').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') login();
            });

            document.getElementById('registerPassword').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') register();
            });
        };
    </script>
</body>
</html>
