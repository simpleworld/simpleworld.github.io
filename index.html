<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messenger - Telegram Style</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f4f4f5;
            --bg-tertiary: #e5e5ea;
            --text-primary: #000000;
            --text-secondary: #6e6e73;
            --accent: #0088cc;
            --accent-hover: #006699;
            --message-out: #effdde;
            --message-in: #ffffff;
            --border: #d1d1d6;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #212121;
            --bg-secondary: #181818;
            --bg-tertiary: #2c2c2c;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --accent: #5eb3f6;
            --accent-hover: #4a9dd9;
            --message-out: #2b5278;
            --message-in: #2c2c2c;
            --border: #3a3a3a;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* ========== AUTH SCREEN ========== */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
        }

        .auth-box {
            background: var(--bg-primary);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px var(--shadow);
            width: 400px;
            max-width: 90%;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: var(--accent);
            font-size: 32px;
            margin-bottom: 8px;
        }

        .auth-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: transparent;
            color: var(--accent);
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
        }

        .error-message {
            background: #ff3b30;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* ========== MAIN APP ========== */
        .app-container {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .app-container.active {
            display: flex;
        }

        /* Header */
        .app-header {
            background: var(--accent);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .app-header h1 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .hamburger-menu {
            cursor: pointer;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: opacity 0.3s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-width: 40px;
            min-height: 40px;
            align-items: center;
            justify-content: center;
        }

        .hamburger-menu:hover {
            opacity: 0.8;
        }

        .hamburger-menu:active {
            opacity: 0.6;
        }

        .hamburger-line {
            width: 24px;
            height: 3px;
            background: white;
            border-radius: 2px;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            text-align: right;
        }

        .user-nickname {
            font-weight: 600;
            font-size: 15px;
        }

        .user-status {
            font-size: 12px;
            opacity: 0.8;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-logout {
            background: rgba(255, 59, 48, 0.9);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 36px;
        }

        .btn-logout:hover {
            background: rgba(255, 59, 48, 1);
        }

        .btn-logout:active {
            background: rgba(200, 40, 30, 1);
        }

        /* Main Content */
        .app-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .search-container {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 72px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .chat-item:hover {
            background: var(--bg-secondary);
        }

        .chat-item:active {
            background: var(--bg-tertiary);
        }

        .chat-item.active {
            background: var(--bg-tertiary);
        }

        .chat-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .chat-item-name {
            font-weight: 600;
            font-size: 15px;
        }

        .chat-item-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chat-item-preview {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .empty-chats {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
        }

        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
        }

        .empty-chat-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .chat-header {
            background: var(--bg-primary);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: none;
        }

        .chat-header.active {
            display: block;
        }

        .chat-header-name {
            font-size: 16px;
            font-weight: 600;
        }

        .chat-header-status {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }

        .messages-container.active {
            display: block;
        }

        .message {
            display: flex;
            margin-bottom: 12px;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.out {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 60%;
            padding: 10px 14px;
            border-radius: 12px;
            position: relative;
        }

        .message.in .message-bubble {
            background: var(--message-in);
            border: 1px solid var(--border);
            border-bottom-left-radius: 2px;
        }

        .message.out .message-bubble {
            background: var(--message-out);
            border-bottom-right-radius: 2px;
        }

        .message-text {
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            text-align: right;
        }

        .message.in .message-time {
            text-align: left;
        }

        /* Input Area */
        .input-area {
            background: var(--bg-primary);
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: none;
        }

        .input-area.active {
            display: block;
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-container textarea {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .input-container textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-send {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            white-space: nowrap;
        }

        .btn-send:hover {
            background: var(--accent-hover);
        }

        .btn-send:active {
            background: var(--accent-hover);
            opacity: 0.8;
        }

        .btn-send:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header {
                padding: 10px 12px;
            }

            .app-header h1 {
                font-size: 18px;
                gap: 12px;
            }

            .hamburger-line {
                width: 22px;
                height: 2.5px;
            }

            .header-user {
                gap: 10px;
            }

            .user-info .user-nickname {
                font-size: 14px;
            }

            .user-info .user-status {
                font-size: 11px;
            }

            .btn-logout {
                padding: 8px 14px;
                font-size: 13px;
                min-height: 38px;
            }

            .sidebar {
                width: 100%;
            }

            .search-container {
                padding: 12px;
            }

            .search-box input {
                padding: 12px 16px;
                font-size: 15px;
            }

            .chat-item {
                padding: 14px 12px;
                min-height: 76px;
            }

            .chat-item-name {
                font-size: 16px;
            }

            .chat-item-preview {
                font-size: 14px;
            }

            .chat-area {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 100;
                background: var(--bg-secondary);
            }

            .chat-area.mobile-active {
                display: flex !important;
            }

            .empty-chat {
                display: none !important;
            }

            .chat-header {
                padding: 14px 12px;
                border-bottom: 2px solid var(--border);
            }

            .chat-header-name {
                font-size: 16px;
            }

            .chat-header-status {
                font-size: 12px;
            }

            .btn-back {
                display: inline-flex !important;
                font-size: 24px;
                padding: 8px;
                min-width: 40px;
                min-height: 40px;
                align-items: center;
                justify-content: center;
                margin-right: 4px;
            }

            .messages-container {
                padding: 16px 12px;
            }

            .message {
                margin-bottom: 10px;
            }

            .message-bubble {
                max-width: 85%;
                padding: 12px 14px;
            }

            .message-text {
                font-size: 15px;
            }

            .input-area {
                padding: 12px;
                border-top: 2px solid var(--border);
            }

            .input-container {
                gap: 10px;
            }

            .input-container textarea {
                font-size: 15px;
                padding: 12px 16px;
            }

            .btn-send {
                padding: 12px 22px;
                font-size: 15px;
                min-height: 46px;
            }

            .modal-content {
                max-height: 90vh;
                width: 95%;
                max-width: 400px;
            }

            .modal-body {
                padding: 16px;
            }

            .settings-item {
                padding: 14px 0;
            }

            .settings-label {
                font-size: 15px;
            }

            .settings-description {
                font-size: 13px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-group input {
                padding: 14px 16px;
                font-size: 15px;
            }

            .ban-duration-buttons {
                flex-direction: column;
            }

            .btn-ban {
                width: 100%;
                padding: 12px 16px;
                font-size: 14px;
            }

            .auth-box {
                padding: 30px 20px;
                width: 95%;
            }

            .auth-header h1 {
                font-size: 28px;
            }

            .form-group input {
                padding: 14px 16px;
                font-size: 15px;
            }

            .btn {
                padding: 16px;
                font-size: 16px;
            }
        }

        .btn-back {
            display: none;
            align-items: center;
            background: transparent;
            color: var(--text-primary);
            border: none;
            padding: 8px 4px;
            font-size: 15px;
            cursor: pointer;
            gap: 4px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-back:active {
            opacity: 0.6;
        }

        @media (max-width: 768px) {
            .chat-header.active .btn-back {
                display: inline-flex !important;
            }
        }

        .hidden {
            display: none !important;
        }

        /* ========== SETTINGS MODAL ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 0;
            width: 400px;
            max-width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 8px 32px var(--shadow);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: var(--accent);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
            margin: 0;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 20px;
            max-height: calc(80vh - 60px);
            overflow-y: auto;
        }

        .settings-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .settings-description {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .admin-link {
            color: var(--text-secondary);
            font-size: 11px;
            margin-top: 20px;
            text-align: center;
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.3s;
        }

        .admin-link:hover {
            opacity: 0.5;
        }

        .admin-password-input {
            margin-top: 8px;
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .admin-password-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .admin-panel {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border);
        }

        .admin-title {
            font-size: 16px;
            font-weight: 600;
            color: #ff3b30;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .admin-section:last-child {
            border-bottom: none;
        }

        .admin-section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .verified-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .btn-remove {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-remove:hover {
            background: #d32f2f;
        }

        .ban-duration-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .btn-ban {
            background: var(--text-secondary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
            flex: 1;
            min-width: 80px;
        }

        .btn-ban:hover {
            background: var(--accent-hover);
        }

        .btn-ban.permanent {
            background: #ff3b30;
        }

        .btn-ban.permanent:hover {
            background: #d32f2f;
        }

        .banned-message {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .banned-message.show {
            display: flex;
        }

        .banned-content {
            background: var(--bg-primary);
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }

        .banned-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .banned-title {
            font-size: 24px;
            font-weight: 600;
            color: #ff3b30;
            margin-bottom: 12px;
        }

        .banned-text {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .verified-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #0088cc 0%, #0066aa 100%);
            color: white;
            font-size: 11px;
            font-weight: bold;
            margin-left: 4px;
            transform: rotate(45deg);
            position: relative;
            top: -1px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 136, 204, 0.3);
        }

        .verified-badge::before {
            content: '‚úì';
            transform: rotate(-45deg);
            display: block;
        }
    </style>
</head>
<body>
    <!-- ========== AUTH SCREEN ========== -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <!-- Login Form -->
            <div id="loginForm">
                <div class="auth-header">
                    <h1>Messenger</h1>
                    <p>–£–≤—ñ–π–¥—ñ—Ç—å —É —Å–≤—ñ–π –∞–∫–∞—É–Ω—Ç</p>
                </div>
                <div class="error-message" id="loginError"></div>
                <div class="form-group">
                    <label for="loginUsername">–õ–æ–≥—ñ–Ω</label>
                    <input type="text" id="loginUsername" placeholder="–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω">
                </div>
                <div class="form-group">
                    <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn btn-primary" onclick="login()">–£–≤—ñ–π—Ç–∏</button>
                <button class="btn btn-secondary" onclick="showRegister()">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç</button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <div class="auth-header">
                    <h1>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h1>
                    <p>–°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –∞–∫–∞—É–Ω—Ç</p>
                </div>
                <div class="error-message" id="registerError"></div>
                <div class="form-group">
                    <label for="registerNickname">–ù—ñ–∫–Ω–µ–π–º</label>
                    <input type="text" id="registerNickname" placeholder="–í–∞—à –Ω—ñ–∫–Ω–µ–π–º">
                </div>
                <div class="form-group">
                    <label for="registerUsername">–õ–æ–≥—ñ–Ω</label>
                    <input type="text" id="registerUsername" placeholder="–°—Ç–≤–æ—Ä—ñ—Ç—å –ª–æ–≥—ñ–Ω">
                </div>
                <div class="form-group">
                    <label for="registerPassword">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="registerPassword" placeholder="–°—Ç–≤–æ—Ä—ñ—Ç—å –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn btn-primary" onclick="register()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
                <button class="btn btn-secondary" onclick="showLogin()">–í–∂–µ —î –∞–∫–∞—É–Ω—Ç</button>
            </div>
        </div>
    </div>

    <!-- ========== MAIN APP ========== -->
    <div class="app-container" id="appContainer">
        <div class="app-header">
            <h1>
                <div class="hamburger-menu" onclick="openSettings()">
                    <div class="hamburger-line"></div>
                    <div class="hamburger-line"></div>
                    <div class="hamburger-line"></div>
                </div>
                Messenger
            </h1>
            <div class="header-user">
                <div class="user-info">
                    <div class="user-nickname" id="currentUserNickname"></div>
                    <div class="user-status">–≤ –º–µ—Ä–µ–∂—ñ</div>
                </div>
                <button class="btn-logout" onclick="logout()">–í–∏–π—Ç–∏</button>
            </div>
        </div>

        <div class="app-main">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤..." onkeyup="searchUsers()">
                    </div>
                </div>
                <div class="chat-list" id="chatList">
                    <div class="empty-chats">
                        <p>–ü–æ—á–Ω—ñ—Ç—å —Ä–æ–∑–º–æ–≤—É!</p>
                        <p style="font-size: 13px; margin-top: 8px;">–ó–Ω–∞–π–¥—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ –Ω—ñ–∫–Ω–µ–π–º–æ–º</p>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area" id="chatArea">
                <div class="empty-chat">
                    <div class="empty-chat-icon">üí¨</div>
                    <h2>–í–∏–±–µ—Ä—ñ—Ç—å —á–∞—Ç</h2>
                    <p>–û–±–µ—Ä—ñ—Ç—å –¥—ñ–∞–ª–æ–≥ –∑–ª—ñ–≤–∞ –∞–±–æ –∑–Ω–∞–π–¥—ñ—Ç—å –Ω–æ–≤–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞</p>
                </div>

                <div class="chat-header" id="chatHeader">
                    <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                        <button class="btn-back" onclick="closeChat()">‚Üê</button>
                        <div>
                            <div class="chat-header-name" id="chatHeaderName"></div>
                            <div class="chat-header-status">–≤ –º–µ—Ä–µ–∂—ñ</div>
                        </div>
                    </div>
                </div>

                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be loaded here -->
                </div>

                <div class="input-area" id="inputArea">
                    <div class="input-container">
                        <textarea id="messageInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." rows="1" onkeydown="handleMessageKeyDown(event)"></textarea>
                        <button class="btn-send" onclick="sendMessage()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== BANNED MESSAGE ========== -->
    <div class="banned-message" id="bannedMessage">
        <div class="banned-content">
            <div class="banned-icon">üö´</div>
            <div class="banned-title">–ê–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ</div>
            <div class="banned-text" id="bannedText">–í–∞—à –∞–∫–∞—É–Ω—Ç –±—É–ª–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</div>
            <div class="banned-text" id="bannedUntil"></div>
            <button class="btn btn-primary" style="margin-top: 20px;" onclick="location.reload()">–û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É</button>
        </div>
    </div>

    <!-- ========== SETTINGS MODAL ========== -->
    <div class="modal-overlay" id="settingsModal" onclick="closeSettingsOnOverlay(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="settings-item">
                    <div>
                        <div class="settings-label">–¢–µ–º–∞ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É</div>
                        <div class="settings-description">–°–≤—ñ—Ç–ª–∞ –∞–±–æ —Ç–µ–º–Ω–∞ —Ç–µ–º–∞</div>
                    </div>
                    <button class="btn btn-primary" style="width: auto; padding: 8px 16px;" onclick="toggleTheme()">–ó–º—ñ–Ω–∏—Ç–∏ —Ç–µ–º—É</button>
                </div>

                <div class="settings-item">
                    <div>
                        <div class="settings-label">–ú—ñ–π –Ω—ñ–∫–Ω–µ–π–º</div>
                        <div class="settings-description" id="settingsNickname"></div>
                    </div>
                </div>

                <div class="settings-item">
                    <div>
                        <div class="settings-label">–ú—ñ–π –ª–æ–≥—ñ–Ω</div>
                        <div class="settings-description" id="settingsUsername"></div>
                    </div>
                </div>

                <div class="settings-item">
                    <div>
                        <div class="settings-label">–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó</div>
                        <div class="settings-description" id="settingsCreatedAt"></div>
                    </div>
                </div>

                <div class="settings-item">
                    <div>
                        <div class="settings-label">–û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</div>
                        <div class="settings-description">–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –≤–∞—à—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</div>
                    </div>
                    <button class="btn btn-remove" style="width: auto; padding: 8px 16px;" onclick="clearMyMessages()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
                </div>

                <div class="settings-item">
                    <div>
                        <div class="settings-label">–ï–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö</div>
                        <div class="settings-description">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å—ñ –≤–∞—à—ñ –¥–∞–Ω—ñ</div>
                    </div>
                    <button class="btn btn-primary" style="width: auto; padding: 8px 16px;" onclick="exportUserData()">–ï–∫—Å–ø–æ—Ä—Ç</button>
                </div>

                <div class="admin-link" onclick="showAdminPasswordInput()">
                    –ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å
                </div>

                <div id="adminPasswordSection" class="hidden">
                    <input type="password" id="adminPasswordInput" class="admin-password-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –∞–¥–º—ñ–Ω–∞">
                    <button class="btn btn-primary" style="margin-top: 12px;" onclick="checkAdminPassword()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
                </div>

                <div id="adminPanel" class="admin-panel hidden">
                    <div class="admin-title">üîí –ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å</div>
                    
                    <!-- Statistics Section -->
                    <div class="admin-section">
                        <div class="admin-section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">
                            <div style="padding: 8px 0;">–í—Å—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: <strong id="totalUsers"></strong></div>
                            <div style="padding: 8px 0;">–í—Å—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å: <strong id="totalMessages"></strong></div>
                            <div style="padding: 8px 0;">–í–µ—Ä—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏—Ö: <strong id="totalVerified"></strong></div>
                            <div style="padding: 8px 0;">–ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏—Ö: <strong id="totalBanned"></strong></div>
                        </div>
                    </div>

                    <!-- Verification Section -->
                    <div class="admin-section">
                        <div class="admin-section-title">‚úì –í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è</div>
                        <div class="form-group">
                            <label for="verifyNickname">–ù—ñ–∫–Ω–µ–π–º –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó</label>
                            <input type="text" id="verifyNickname" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫–Ω–µ–π–º">
                        </div>
                        <button class="btn btn-primary" onclick="verifyUser()">‚úì –í–∏–¥–∞—Ç–∏ –≥–∞–ª–æ—á–∫—É</button>
                        
                        <div style="margin-top: 20px;">
                            <div class="admin-section-title">–í–µ—Ä—ñ—Ñ—ñ–∫–æ–≤–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ:</div>
                            <div id="verifiedUsersList" style="font-size: 14px; color: var(--text-secondary);"></div>
                        </div>
                    </div>

                    <!-- Ban Section -->
                    <div class="admin-section">
                        <div class="admin-section-title">üö´ –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</div>
                        <div class="form-group">
                            <label for="banNickname">–ù—ñ–∫–Ω–µ–π–º –¥–ª—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è</label>
                            <input type="text" id="banNickname" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫–Ω–µ–π–º">
                        </div>
                        <div class="ban-duration-buttons">
                            <button class="btn-ban" onclick="banUser(5)">5 —Ö–≤–∏–ª–∏–Ω</button>
                            <button class="btn-ban" onclick="banUser(10)">10 —Ö–≤–∏–ª–∏–Ω</button>
                            <button class="btn-ban" onclick="banUser(60)">1 –≥–æ–¥–∏–Ω–∞</button>
                            <button class="btn-ban" onclick="banUser(1440)">1 –¥–µ–Ω—å</button>
                            <button class="btn-ban permanent" onclick="banUser('permanent')">–ù–∞–∑–∞–≤–∂–¥–∏</button>
                        </div>

                        <div style="margin-top: 20px;">
                            <div class="admin-section-title">–ó–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ:</div>
                            <div id="bannedUsersList" style="font-size: 14px; color: var(--text-secondary);"></div>
                        </div>
                    </div>

                    <!-- User Management Section -->
                    <div class="admin-section">
                        <div class="admin-section-title">üë• –í—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</div>
                        <div id="allUsersList" style="font-size: 14px; color: var(--text-secondary); max-height: 300px; overflow-y: auto;"></div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="admin-section">
                        <div class="admin-section-title" style="color: #ff3b30;">‚ö†Ô∏è –ù–µ–±–µ–∑–ø–µ—á–Ω–∞ –∑–æ–Ω–∞</div>
                        <button class="btn btn-remove" style="width: 100%; margin-bottom: 8px;" onclick="clearAllMessages()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</button>
                        <button class="btn btn-remove" style="width: 100%;" onclick="resetAllData()">üí£ –°–∫–∏–Ω—É—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== GLOBALS ==========
        let currentUser = null;
        let activeChat = null;
        let lastMessageCount = 0;
        let autoRefreshInterval = null;
        let banCheckInterval = null;
        const ADMIN_PASSWORD = '12364578TYRR';

        // ========== UTILITY FUNCTIONS ==========
        
        // –û—Ç—Ä–∏–º–∞—Ç–∏ –≤–µ—Ä—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        function getVerifiedUsers() {
            const verified = localStorage.getItem('messenger_verified');
            return verified ? JSON.parse(verified) : [];
        }

        // –ó–±–µ—Ä–µ–≥—Ç–∏ –≤–µ—Ä—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        function saveVerifiedUsers(verified) {
            localStorage.setItem('messenger_verified', JSON.stringify(verified));
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–µ—Ä—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π
        function isUserVerified(nickname) {
            const verified = getVerifiedUsers();
            return verified.includes(nickname);
        }

        // –û—Ç—Ä–∏–º–∞—Ç–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        function getBannedUsers() {
            const banned = localStorage.getItem('messenger_banned');
            return banned ? JSON.parse(banned) : [];
        }

        // –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        function saveBannedUsers(banned) {
            localStorage.setItem('messenger_banned', JSON.stringify(banned));
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π
        function isUserBanned(nickname) {
            const banned = getBannedUsers();
            const ban = banned.find(b => b.nickname === nickname);
            
            if (!ban) return false;
            
            // –Ø–∫—â–æ –±–∞–Ω –Ω–∞–∑–∞–≤–∂–¥–∏
            if (ban.until === 'permanent') return true;
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –º–∏–Ω—É–≤ —á–∞—Å –±–∞–Ω—É
            if (Date.now() < ban.until) return true;
            
            // –ß–∞—Å –±–∞–Ω—É –º–∏–Ω—É–≤ - –≤–∏–¥–∞–ª—è—î–º–æ –∑ —Å–ø–∏—Å–∫—É
            const updatedBanned = banned.filter(b => b.nickname !== nickname);
            saveBannedUsers(updatedBanned);
            return false;
        }

        // –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –±–∞–Ω
        function getBanInfo(nickname) {
            const banned = getBannedUsers();
            return banned.find(b => b.nickname === nickname);
        }
        
        // –ü—Ä–æ—Å—Ç–∞ —Ö–µ—à-—Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–∞—Ä–æ–ª—ñ–≤ (SHA-256 –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        // –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        function getUsers() {
            const users = localStorage.getItem('messenger_users');
            return users ? JSON.parse(users) : [];
        }

        // –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        function saveUsers(users) {
            localStorage.setItem('messenger_users', JSON.stringify(users));
        }

        // –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        function getMessages() {
            const messages = localStorage.getItem('messenger_messages');
            return messages ? JSON.parse(messages) : [];
        }

        // –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        function saveMessages(messages) {
            localStorage.setItem('messenger_messages', JSON.stringify(messages));
        }

        // –û—Ç—Ä–∏–º–∞—Ç–∏ ID —á–∞—Ç—É –º—ñ–∂ –¥–≤–æ–º–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏
        function getChatId(user1, user2) {
            return [user1, user2].sort().join('_');
        }

        // –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —á–∞—Å—É
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            if (date.toDateString() === now.toDateString()) {
                return `${hours}:${minutes}`;
            }
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            return `${day}.${month} ${hours}:${minutes}`;
        }

        // ========== AUTH FUNCTIONS ==========
        
        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 3000);
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function register() {
            const nickname = document.getElementById('registerNickname').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!nickname || !username || !password) {
                showError('registerError', '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è!');
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –¥–æ–ø—É—Å—Ç–∏–º—ñ —Å–∏–º–≤–æ–ª–∏ (—Ç—ñ–ª—å–∫–∏ –±—É–∫–≤–∏ —Ç–∞ —Ü–∏—Ñ—Ä–∏)
            const validPattern = /^[a-zA-Z0-9–∞-—è–ê-–Ø—ñ–Ü—ó–á—î–Ñ“ë“ê]+$/;
            
            if (!validPattern.test(nickname)) {
                showError('registerError', '–ù—ñ–∫–Ω–µ–π–º –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –±—É–∫–≤–∏ —Ç–∞ —Ü–∏—Ñ—Ä–∏!');
                return;
            }

            if (!validPattern.test(username)) {
                showError('registerError', '–õ–æ–≥—ñ–Ω –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –±—É–∫–≤–∏ —Ç–∞ —Ü–∏—Ñ—Ä–∏!');
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —â–æ –ª–æ–≥—ñ–Ω —Ç–∞ –Ω—ñ–∫–Ω–µ–π–º –Ω–µ —Å–∫–ª–∞–¥–∞—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –∑ —Ü–∏—Ñ—Ä
            if (/^\d+$/.test(nickname)) {
                showError('registerError', '–ù—ñ–∫–Ω–µ–π–º –Ω–µ –º–æ–∂–µ —Å–∫–ª–∞–¥–∞—Ç–∏—Å—è —Ç—ñ–ª—å–∫–∏ –∑ —Ü–∏—Ñ—Ä!');
                return;
            }

            if (/^\d+$/.test(username)) {
                showError('registerError', '–õ–æ–≥—ñ–Ω –Ω–µ –º–æ–∂–µ —Å–∫–ª–∞–¥–∞—Ç–∏—Å—è —Ç—ñ–ª—å–∫–∏ –∑ —Ü–∏—Ñ—Ä!');
                return;
            }

            if (nickname.length < 2 || username.length < 3) {
                showError('registerError', '–ù—ñ–∫–Ω–µ–π–º –º—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏, –ª–æ–≥—ñ–Ω –º—ñ–Ω—ñ–º—É–º 3!');
                return;
            }

            if (password.length < 4) {
                showError('registerError', '–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 4 —Å–∏–º–≤–æ–ª–∏!');
                return;
            }

            const users = getUsers();
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —ñ—Å–Ω—É—é—á–∏–π –ª–æ–≥—ñ–Ω
            if (users.find(u => u.username.toLowerCase() === username.toLowerCase())) {
                showError('registerError', '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º –ª–æ–≥—ñ–Ω–æ–º –≤–∂–µ —ñ—Å–Ω—É—î!');
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —ñ—Å–Ω—É—é—á–∏–π –Ω—ñ–∫–Ω–µ–π–º
            if (users.find(u => u.nickname.toLowerCase() === nickname.toLowerCase())) {
                showError('registerError', '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º –Ω—ñ–∫–Ω–µ–π–º–æ–º –≤–∂–µ —ñ—Å–Ω—É—î!');
                return;
            }

            // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            const newUser = {
                id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                nickname: nickname,
                username: username,
                password: simpleHash(password),
                createdAt: Date.now()
            };

            users.push(newUser);
            saveUsers(users);

            // –û—á–∏—â–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏
            document.getElementById('registerNickname').value = '';
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerPassword').value = '';

            showLogin();
            showError('loginError', '‚úì –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –£–≤—ñ–π–¥—ñ—Ç—å —É —Å–∏—Å—Ç–µ–º—É.');
        }

        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showError('loginError', '–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω —Ç–∞ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            const users = getUsers();
            const user = users.find(u => u.username === username && u.password === simpleHash(password));

            if (!user) {
                showError('loginError', '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –±–∞–Ω
            if (isUserBanned(user.nickname)) {
                showBannedMessage(user.nickname);
                return;
            }

            // –£—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥
            currentUser = user;
            sessionStorage.setItem('currentUser', JSON.stringify(user));
            
            // –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –¥–æ–¥–∞—Ç–∫—É
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            
            initApp();
        }

        function logout() {
            // –ó—É–ø–∏–Ω—è—î–º–æ –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }

            // –ó—É–ø–∏–Ω—è—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –±–∞–Ω—ñ–≤
            if (banCheckInterval) {
                clearInterval(banCheckInterval);
                banCheckInterval = null;
            }

            currentUser = null;
            activeChat = null;
            sessionStorage.removeItem('currentUser');
            
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('active');
            
            // –û—á–∏—â–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏ –≤—Ö–æ–¥—É
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            
            showLogin();
        }

        // ========== APP FUNCTIONS ==========
        
        function initApp() {
            const nicknameEl = document.getElementById('currentUserNickname');
            nicknameEl.textContent = currentUser.nickname;
            
            // –î–æ–¥–∞—î–º–æ –≥–∞–ª–æ—á–∫—É —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–µ—Ä—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π
            if (isUserVerified(currentUser.nickname)) {
                nicknameEl.innerHTML = currentUser.nickname + '<span class="verified-badge"></span>';
            }
            
            loadChats();
            startAutoRefresh();
            startBanCheck();
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –±–∞–Ω –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥
        function startBanCheck() {
            if (banCheckInterval) {
                clearInterval(banCheckInterval);
            }

            banCheckInterval = setInterval(() => {
                if (currentUser && isUserBanned(currentUser.nickname)) {
                    showBannedMessage(currentUser.nickname);
                }
            }, 5000);
        }

        function showBannedMessage(nickname) {
            const banInfo = getBanInfo(nickname);
            const bannedMessageEl = document.getElementById('bannedMessage');
            const bannedTextEl = document.getElementById('bannedText');
            const bannedUntilEl = document.getElementById('bannedUntil');

            if (banInfo.until === 'permanent') {
                bannedTextEl.textContent = '–í–∞—à –∞–∫–∞—É–Ω—Ç –±—É–ª–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –Ω–∞–∑–∞–≤–∂–¥–∏.';
                bannedUntilEl.textContent = '';
            } else {
                const untilDate = new Date(banInfo.until);
                bannedTextEl.textContent = '–í–∞—à –∞–∫–∞—É–Ω—Ç —Ç–∏–º—á–∞—Å–æ–≤–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ.';
                bannedUntilEl.textContent = `–ë–∞–Ω –¥—ñ—î –¥–æ: ${untilDate.toLocaleString('uk-UA')}`;
            }

            bannedMessageEl.classList.add('show');

            // –í–∏—Ö–æ–¥–∏–º–æ –∑ –∞–∫–∞—É–Ω—Ç–∞
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (banCheckInterval) {
                clearInterval(banCheckInterval);
            }
            
            currentUser = null;
            activeChat = null;
            sessionStorage.removeItem('currentUser');
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        function startAutoRefresh() {
            // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª —è–∫—â–æ —î
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 2 —Å–µ–∫—É–Ω–¥–∏
            autoRefreshInterval = setInterval(() => {
                checkForNewMessages();
            }, 2000);
        }

        function checkForNewMessages() {
            const messages = getMessages();
            const currentMessageCount = messages.length;

            // –Ø–∫—â–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑–º—ñ–Ω–∏–ª–∞—Å—å
            if (currentMessageCount !== lastMessageCount) {
                lastMessageCount = currentMessageCount;

                // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤
                const searchQuery = document.getElementById('searchInput').value.trim();
                if (!searchQuery) {
                    loadChats();
                }

                // –Ø–∫—â–æ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π –∞–∫—Ç–∏–≤–Ω–∏–π —á–∞—Ç - –æ–Ω–æ–≤–ª—é—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                if (activeChat) {
                    const chatId = getChatId(currentUser.username, activeChat.username);
                    const chatMessages = messages.filter(m => m.chatId === chatId);
                    const messagesContainer = document.getElementById('messagesContainer');
                    const currentScrollHeight = messagesContainer.scrollHeight;
                    const currentScrollTop = messagesContainer.scrollTop;
                    const isScrolledToBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop <= messagesContainer.clientHeight + 100;

                    loadMessages();

                    // –ü—Ä–æ–∫—Ä—É—á—É—î–º–æ –≤–Ω–∏–∑ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±—É–≤ –≤–Ω–∏–∑—É
                    if (isScrolledToBottom) {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }
            }
        }

        function loadChats() {
            const chatListEl = document.getElementById('chatList');
            const messages = getMessages();
            const users = getUsers().filter(u => u.id !== currentUser.id);

            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ç—ñ–ª—å–∫–∏ —Ç–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, –∑ —è–∫–∏–º–∏ —î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            const chatsWithMessages = [];
            
            users.forEach(user => {
                const chatId = getChatId(currentUser.username, user.username);
                const chatMessages = messages.filter(m => m.chatId === chatId);
                
                if (chatMessages.length > 0) {
                    const lastMessage = chatMessages[chatMessages.length - 1];
                    chatsWithMessages.push({
                        user: user,
                        lastMessage: lastMessage,
                        timestamp: lastMessage.timestamp
                    });
                }
            });

            if (chatsWithMessages.length === 0) {
                chatListEl.innerHTML = `
                    <div class="empty-chats">
                        <p>–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö —á–∞—Ç—ñ–≤</p>
                        <p style="font-size: 13px; margin-top: 8px;">–ó–Ω–∞–π–¥—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ –Ω—ñ–∫–Ω–µ–π–º–æ–º</p>
                    </div>
                `;
                return;
            }

            // –°–æ—Ä—Ç—É—î–º–æ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º
            chatsWithMessages.sort((a, b) => b.timestamp - a.timestamp);

            chatListEl.innerHTML = chatsWithMessages.map(chat => {
                const verifiedBadge = isUserVerified(chat.user.nickname) ? '<span class="verified-badge"></span>' : '';
                return `
                    <div class="chat-item ${activeChat && activeChat.id === chat.user.id ? 'active' : ''}" 
                         onclick="openChat('${chat.user.id}')">
                        <div class="chat-item-header">
                            <div class="chat-item-name">${chat.user.nickname}${verifiedBadge}</div>
                            <div class="chat-item-time">${formatTime(chat.lastMessage.timestamp)}</div>
                        </div>
                        <div class="chat-item-preview">${escapeHtml(chat.lastMessage.text)}</div>
                    </div>
                `;
            }).join('');
        }

        function searchUsers() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!query) {
                loadChats();
                return;
            }

            const users = getUsers().filter(u => 
                u.id !== currentUser.id && 
                u.nickname.toLowerCase().includes(query)
            );

            const chatListEl = document.getElementById('chatList');

            if (users.length === 0) {
                chatListEl.innerHTML = `
                    <div class="empty-chats">
                        <p>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>
                        <p style="font-size: 13px; margin-top: 8px;">–°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –∑–∞–ø–∏—Ç</p>
                    </div>
                `;
                return;
            }

            chatListEl.innerHTML = users.map(user => {
                const verifiedBadge = isUserVerified(user.nickname) ? '<span class="verified-badge"></span>' : '';
                return `
                    <div class="chat-item ${activeChat && activeChat.id === user.id ? 'active' : ''}" 
                         onclick="openChat('${user.id}')">
                        <div class="chat-item-header">
                            <div class="chat-item-name">${user.nickname}${verifiedBadge}</div>
                        </div>
                        <div class="chat-item-preview">@${user.username}</div>
                    </div>
                `;
            }).join('');
        }

        function openChat(userId) {
            const users = getUsers();
            const user = users.find(u => u.id === userId);
            
            if (!user) return;

            activeChat = user;

            // –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç—É –∑ –≥–∞–ª–æ—á–∫–æ—é —è–∫—â–æ —î
            const verifiedBadge = isUserVerified(user.nickname) ? '<span class="verified-badge"></span>' : '';
            document.getElementById('chatHeaderName').innerHTML = user.nickname + verifiedBadge;
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏ —á–∞—Ç—É
            document.querySelector('.empty-chat').style.display = 'none';
            document.getElementById('chatHeader').classList.add('active');
            document.getElementById('messagesContainer').classList.add('active');
            document.getElementById('inputArea').classList.add('active');

            // –ú–æ–±—ñ–ª—å–Ω–∞ –≤–µ—Ä—Å—ñ—è - –ø–æ–∫–∞–∑—É—î–º–æ —á–∞—Ç –ø–æ–≤–µ—Ä—Ö –≤—Å—å–æ–≥–æ
            if (window.innerWidth <= 768) {
                document.getElementById('chatArea').classList.add('mobile-active');
            }

            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            loadMessages();

            // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤
            loadChats();
        }

        function closeChat() {
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ —Å–ø–∏—Å–∫—É —á–∞—Ç—ñ–≤ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö
            if (window.innerWidth <= 768) {
                document.getElementById('chatArea').classList.remove('mobile-active');
            }
        }

        function loadMessages() {
            if (!activeChat) return;

            const chatId = getChatId(currentUser.username, activeChat.username);
            const messages = getMessages().filter(m => m.chatId === chatId);
            const messagesContainer = document.getElementById('messagesContainer');

            messagesContainer.innerHTML = messages.map(msg => {
                const isOut = msg.from === currentUser.username;
                return `
                    <div class="message ${isOut ? 'out' : 'in'}">
                        <div class="message-bubble">
                            <div class="message-text">${escapeHtml(msg.text)}</div>
                            <div class="message-time">${formatTime(msg.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage() {
            if (!activeChat) return;

            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text) return;

            const chatId = getChatId(currentUser.username, activeChat.username);
            const messages = getMessages();

            const newMessage = {
                id: Date.now().toString(),
                chatId: chatId,
                from: currentUser.username,
                to: activeChat.username,
                text: text,
                timestamp: Date.now()
            };

            messages.push(newMessage);
            saveMessages(messages);

            // –û—á–∏—â—É—î–º–æ –ø–æ–ª–µ –≤–≤–æ–¥—É
            input.value = '';
            input.style.height = 'auto';

            // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            loadMessages();
            loadChats();
        }

        function handleMessageKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }

            // –ê–≤—Ç–æ-—Ä–æ–∑–º—ñ—Ä —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== THEME ==========
        
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ–º–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        }

        // ========== SETTINGS & ADMIN ==========
        
        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
            
            // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            if (currentUser) {
                document.getElementById('settingsNickname').textContent = currentUser.nickname;
                document.getElementById('settingsUsername').textContent = currentUser.username;
                const createdDate = new Date(currentUser.createdAt);
                document.getElementById('settingsCreatedAt').textContent = createdDate.toLocaleDateString('uk-UA');
            }
            
            updateVerifiedUsersList();
            updateBannedUsersList();
            updateStatistics();
            updateAllUsersList();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
            document.getElementById('adminPasswordSection').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('adminPasswordInput').value = '';
        }

        function closeSettingsOnOverlay(event) {
            if (event.target.id === 'settingsModal') {
                closeSettings();
            }
        }

        function showAdminPasswordInput() {
            const section = document.getElementById('adminPasswordSection');
            section.classList.toggle('hidden');
        }

        function checkAdminPassword() {
            const password = document.getElementById('adminPasswordInput').value;
            
            if (password === ADMIN_PASSWORD) {
                document.getElementById('adminPasswordSection').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('adminPasswordInput').value = '';
                updateVerifiedUsersList();
                updateBannedUsersList();
                updateStatistics();
                updateAllUsersList();
            } else {
                alert('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–∞—Ä–æ–ª—å!');
                document.getElementById('adminPasswordInput').value = '';
            }
        }

        function verifyUser() {
            const nickname = document.getElementById('verifyNickname').value.trim();
            
            if (!nickname) {
                alert('–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫–Ω–µ–π–º!');
                return;
            }

            const users = getUsers();
            const user = users.find(u => u.nickname === nickname);

            if (!user) {
                alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Ç–∞–∫–∏–º –Ω—ñ–∫–Ω–µ–π–º–æ–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
                return;
            }

            const verified = getVerifiedUsers();
            
            if (verified.includes(nickname)) {
                alert('–¶–µ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –≤–µ—Ä—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π!');
                return;
            }

            verified.push(nickname);
            saveVerifiedUsers(verified);

            document.getElementById('verifyNickname').value = '';
            alert(`‚úì –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ${nickname} –æ—Ç—Ä–∏–º–∞–≤ –≥–∞–ª–æ—á–∫—É –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó!`);
            
            updateVerifiedUsersList();
            updateInterface();
        }

        function removeVerification(nickname) {
            if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—é –∑ ${nickname}?`)) {
                return;
            }

            const verified = getVerifiedUsers();
            const updated = verified.filter(n => n !== nickname);
            saveVerifiedUsers(updated);

            updateVerifiedUsersList();
            updateInterface();
            alert(`–í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ –∑ ${nickname}`);
        }

        function updateVerifiedUsersList() {
            const verified = getVerifiedUsers();
            const listEl = document.getElementById('verifiedUsersList');
            
            if (verified.length === 0) {
                listEl.innerHTML = '<div style="opacity: 0.5;">–ù–µ–º–∞—î –≤–µ—Ä—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</div>';
            } else {
                listEl.innerHTML = verified.map(nick => 
                    `<div class="verified-user-item">
                        <span>${nick} <span class="verified-badge"></span></span>
                        <button class="btn-remove" onclick="removeVerification('${nick}')">‚úï –í–∏–¥–∞–ª–∏—Ç–∏</button>
                    </div>`
                ).join('');
            }
        }

        function banUser(duration) {
            const nickname = document.getElementById('banNickname').value.trim();
            
            if (!nickname) {
                alert('–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫–Ω–µ–π–º!');
                return;
            }

            const users = getUsers();
            const user = users.find(u => u.nickname === nickname);

            if (!user) {
                alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Ç–∞–∫–∏–º –Ω—ñ–∫–Ω–µ–π–º–æ–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
                return;
            }

            const banned = getBannedUsers();
            
            // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π –±–∞–Ω —è–∫—â–æ —î
            const filteredBanned = banned.filter(b => b.nickname !== nickname);

            let until;
            let durationText;

            if (duration === 'permanent') {
                until = 'permanent';
                durationText = '–Ω–∞–∑–∞–≤–∂–¥–∏';
            } else {
                until = Date.now() + (duration * 60 * 1000); // —Ö–≤–∏–ª–∏–Ω–∏ –≤ –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥–∏
                durationText = `–Ω–∞ ${duration} —Ö–≤–∏–ª–∏–Ω`;
            }

            filteredBanned.push({
                nickname: nickname,
                username: user.username,
                bannedAt: Date.now(),
                until: until
            });

            saveBannedUsers(filteredBanned);

            document.getElementById('banNickname').value = '';
            alert(`üö´ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${nickname} –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ ${durationText}!`);
            
            updateBannedUsersList();

            // –Ø–∫—â–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞—Ä–∞–∑ –≤ –º–µ—Ä–µ–∂—ñ
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                const currentSessionUser = JSON.parse(savedUser);
                if (currentSessionUser.nickname === nickname) {
                    // –¶–µ —Å–ø—Ä–∞—Ü—é—î –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –±—É–¥–µ –≤—ñ–¥–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–æ—Ç—è–≥–æ–º 5 —Å–µ–∫—É–Ω–¥');
                }
            }
        }

        function unbanUser(nickname) {
            if (!confirm(`–†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏ ${nickname}?`)) {
                return;
            }

            const banned = getBannedUsers();
            const updated = banned.filter(b => b.nickname !== nickname);
            saveBannedUsers(updated);

            updateBannedUsersList();
            alert(`–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${nickname} —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ`);
        }

        function updateBannedUsersList() {
            const banned = getBannedUsers();
            const listEl = document.getElementById('bannedUsersList');
            
            if (banned.length === 0) {
                listEl.innerHTML = '<div style="opacity: 0.5;">–ù–µ–º–∞—î –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</div>';
            } else {
                listEl.innerHTML = banned.map(ban => {
                    let untilText;
                    if (ban.until === 'permanent') {
                        untilText = '–ù–∞–∑–∞–≤–∂–¥–∏';
                    } else {
                        const untilDate = new Date(ban.until);
                        if (Date.now() > ban.until) {
                            untilText = '–ë–∞–Ω –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è';
                        } else {
                            untilText = `–î–æ ${untilDate.toLocaleString('uk-UA')}`;
                        }
                    }
                    
                    return `<div class="verified-user-item">
                        <div>
                            <div>${ban.nickname}</div>
                            <div style="font-size: 12px; opacity: 0.7;">${untilText}</div>
                        </div>
                        <button class="btn-remove" onclick="unbanUser('${ban.nickname}')">‚úï –†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏</button>
                    </div>`;
                }).join('');
            }
        }

        function updateInterface() {
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å —è–∫—â–æ —Ü–µ –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
            if (currentUser) {
                const nicknameEl = document.getElementById('currentUserNickname');
                nicknameEl.textContent = currentUser.nickname;
                
                if (isUserVerified(currentUser.nickname)) {
                    nicknameEl.innerHTML = currentUser.nickname + '<span class="verified-badge"></span>';
                }
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —á–∞—Ç–∏
            loadChats();
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç—É —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
            if (activeChat) {
                const verifiedBadge = isUserVerified(activeChat.nickname) ? '<span class="verified-badge"></span>' : '';
                document.getElementById('chatHeaderName').innerHTML = activeChat.nickname + verifiedBadge;
            }
        }

        function clearMyMessages() {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –≤–∞—à—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏!')) {
                return;
            }

            const messages = getMessages();
            const filtered = messages.filter(m => m.from !== currentUser.username);
            saveMessages(filtered);
            
            alert('‚úì –í–∞—à—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ!');
            loadChats();
            if (activeChat) {
                loadMessages();
            }
        }

        function exportUserData() {
            const users = getUsers();
            const messages = getMessages();
            const myMessages = messages.filter(m => m.from === currentUser.username || m.to === currentUser.username);
            
            const data = {
                user: currentUser,
                messages: myMessages,
                verified: isUserVerified(currentUser.nickname),
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `messenger_data_${currentUser.nickname}_${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            alert('‚úì –î–∞–Ω—ñ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
        }

        function updateStatistics() {
            const users = getUsers();
            const messages = getMessages();
            const verified = getVerifiedUsers();
            const banned = getBannedUsers();

            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalMessages').textContent = messages.length;
            document.getElementById('totalVerified').textContent = verified.length;
            document.getElementById('totalBanned').textContent = banned.length;
        }

        function updateAllUsersList() {
            const users = getUsers();
            const listEl = document.getElementById('allUsersList');
            
            listEl.innerHTML = users.map(user => {
                const verifiedBadge = isUserVerified(user.nickname) ? '<span class="verified-badge"></span>' : '';
                const createdDate = new Date(user.createdAt).toLocaleDateString('uk-UA');
                return `
                    <div class="verified-user-item">
                        <div>
                            <div>${user.nickname}${verifiedBadge}</div>
                            <div style="font-size: 12px; opacity: 0.7;">@${user.username} ‚Ä¢ ${createdDate}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function clearAllMessages() {
            if (!confirm('‚ö†Ô∏è –í–ò–î–ê–õ–ò–¢–ò –í–°–Ü –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø –í –°–ò–°–¢–ï–ú–Ü?\n–¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏!')) {
                return;
            }

            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ? –¶–µ –≤–∏–¥–∞–ª–∏—Ç—å –í–°–Ü –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤!')) {
                return;
            }

            saveMessages([]);
            alert('‚úì –í—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ!');
            loadChats();
            if (activeChat) {
                loadMessages();
            }
            updateStatistics();
        }

        function resetAllData() {
            if (!confirm('‚ö†Ô∏è –°–ö–ò–ù–£–¢–ò –í–°–Ü –î–ê–ù–Ü?\n–ë—É–¥–µ –≤–∏–¥–∞–ª–µ–Ω–æ:\n- –í—Å—ñ –∞–∫–∞—É–Ω—Ç–∏\n- –í—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è\n- –í—Å—ñ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó\n- –í—Å—ñ –±–∞–Ω–∏\n\n–í–∏ —Ç–∞–∫–æ–∂ –≤–∏–π–¥–µ—Ç–µ –∑ —Å–∏—Å—Ç–µ–º–∏!')) {
                return;
            }

            if (!confirm('–¶–ï –û–°–¢–ê–ù–ù–Ø –ü–ï–†–ï–í–Ü–†–ö–ê!\n–í–∏ —Ç–æ—á–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –í–°–Ü –¥–∞–Ω—ñ –Ω–∞–∑–∞–≤–∂–¥–∏?')) {
                return;
            }

            localStorage.removeItem('messenger_users');
            localStorage.removeItem('messenger_messages');
            localStorage.removeItem('messenger_verified');
            localStorage.removeItem('messenger_banned');
            
            alert('‚úì –í—Å—ñ –¥–∞–Ω—ñ –≤–∏–¥–∞–ª–µ–Ω–æ! –°—Ç–æ—Ä—ñ–Ω–∫–∞ –±—É–¥–µ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞.');
            location.reload();
        }

        // ========== INITIALIZATION ==========
        
        window.onload = function() {
            loadTheme();

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
            lastMessageCount = getMessages().length;

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–æ—ó —Å–µ—Å—ñ—ó
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –Ω–µ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
                if (isUserBanned(currentUser.nickname)) {
                    showBannedMessage(currentUser.nickname);
                    return;
                }
                
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('appContainer').classList.add('active');
                initApp();
            }

            // Enter –Ω–∞ —Ñ–æ—Ä–º–∞—Ö
            document.getElementById('loginPassword').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') login();
            });

            document.getElementById('registerPassword').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') register();
            });
        };
    </script>
</body>
</html>
